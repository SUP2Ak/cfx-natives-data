name: Daily Native Updates

on:
  schedule:
    - cron: '0 0 * * *'  # midnight
  workflow_dispatch:      # manually
    inputs:
      simulate:
        description: 'Simulate changes'
        required: false
        type: boolean
        default: false

jobs:
  update-natives:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          
      - name: Setup directories
        run: |
          mkdir -p original_plugin
          mkdir -p fetched
          mkdir -p plugin/json/gta5
          mkdir -p plugin/json/rdr3
          mkdir -p plugin/lua/gta5
          mkdir -p plugin/lua/rdr3
          
      - name: Build and Run
        id: run
        run: |
          touch fetched/natives.gta5.json
          touch fetched/natives.rdr3.json
          touch fetched/natives.cfx.json
          
          if [[ "${{ inputs.simulate }}" == "true" ]]; then
            cargo run --release -- --simulate-change > changes.txt || true
          else
            cargo run --release > changes.txt || true
          fi
          
          touch changes.txt
          
          echo "CHANGES<<EOF" >> $GITHUB_ENV
          cat changes.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        continue-on-error: true
      
      - name: Check for changes
        id: check
        run: |
          echo "Diff content:"
          if [ -d "plugin" ] && [ -d "original_plugin" ]; then
            diff -r original_plugin plugin || true
          fi
          echo "-------------------"
          
          if [ -f "original_plugin/json/gta5/natives.json" ]; then
            echo "Original GTA5:"
            cat original_plugin/json/gta5/natives.json | head -n 20
          else
            echo "Original GTA5 file not found (first run)"
          fi
          echo "-------------------"
          
          if [ -f "plugin/json/gta5/natives.json" ]; then
            echo "New GTA5:"
            cat plugin/json/gta5/natives.json | head -n 20
          else
            echo "New GTA5 file not found yet"
          fi
          echo "-------------------"
          
          if [ ! -d "original_plugin" ] || [ ! -d "plugin" ] || \
             ! diff -r original_plugin plugin > /dev/null 2>&1; then
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate branch name
        if: steps.check.outputs.changes == 'true'
        id: branch
        run: |
          timestamp=$(date +%Y%m%d-%H%M%S)
          echo "name=update/natives-data-${timestamp}" >> $GITHUB_OUTPUT

      - name: Prepare for PR
        if: steps.check.outputs.changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          echo "changes.txt" >> .gitignore
          echo "original_plugin/" >> .gitignore
          echo "fetched/" >> .gitignore
          echo "target/" >> .gitignore
          
          git add plugin/
          git add .gitignore
          
      - name: Create Pull Request
        if: steps.check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "chore: update natives data"
          title: "${{ inputs.simulate && 'üß™ Test - ' || 'ü§ñ ' }}Daily Natives Update"
          body: |
            ## Detected Changes
            
            ${{ inputs.simulate && '‚ö†Ô∏è This is a simulation of changes ‚ö†Ô∏è\n\n' || '' }}
            ```
            ${{ env.CHANGES }}
            ```
          branch: ${{ steps.branch.outputs.name }}
          base: main
          delete-branch: true
          labels: |
            automated pr
            natives update
            ${{ inputs.simulate && 'simulation' || '' }}

      - name: Handle Conflicts
        if: failure()
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          mkdir -p plugin/json/gta5
          mkdir -p plugin/json/rdr3
          
          git add plugin/json/gta5/natives.json || true
          git add plugin/json/rdr3/natives.json || true
          git add .gitignore
          
          git commit -m "chore: resolve conflicts" || true
          
          git push origin ${{ steps.branch.outputs.name }} --force

      - name: Check PR Status
        if: steps.check.outputs.changes == 'true'
        run: |
          echo "Pull Request created successfully on branch ${{ steps.branch.outputs.name }}"
          echo "The changes have been detected and documented in the PR" 