name: Daily Native Updates

on:
  schedule:
    - cron: '0 0 * * *'  # midnight
  workflow_dispatch:      # manually
    inputs:
      simulate:
        description: 'Simuler des changements'
        required: false
        type: boolean
        default: false

jobs:
  update-natives:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          
      - name: Setup initial files
        run: |
          mkdir -p original_assets
          cp assets/* original_assets/
          
      - name: Build and Run
        id: run
        run: |
          if [[ "${{ inputs.simulate }}" == "true" ]]; then
            cargo run --release -- --simulate-change > changes.txt
          else
            cargo run --release > changes.txt
          fi
          echo "CHANGES<<EOF" >> $GITHUB_ENV
          cat changes.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Check for changes
        id: check
        run: |
          diff -r original_assets assets || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Prepare for PR
        if: steps.check.outputs.changes == 'true'
        run: |
          # Ignorer les fichiers temporaires
          echo "changes.txt" >> .gitignore
          echo "original_assets/" >> .gitignore
          echo "fetched/" >> .gitignore
          echo "target/" >> .gitignore
          
      - name: Create Pull Request
        if: steps.check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "chore: update natives data"
          title: "${{ inputs.simulate && 'üß™ Test - ' || 'ü§ñ ' }}Daily Natives Update"
          body: |
            ## Changements D√©tect√©s
            
            ${{ inputs.simulate && '‚ö†Ô∏è Ceci est une simulation de changements ‚ö†Ô∏è\n\n' || '' }}
            ```
            ${{ env.CHANGES }}
            ```
            
            Cette PR a √©t√© g√©n√©r√©e automatiquement par le workflow de mise √† jour quotidienne.
          branch: update/natives-data
          base: main
          delete-branch: true
          labels: |
            automated pr
            natives update
            ${{ inputs.simulate && 'simulation' || '' }}

      - name: Check PR Status
        if: steps.check.outputs.changes == 'true'
        run: |
          echo "Pull Request cr√©√©e avec succ√®s"
          echo "Les changements ont √©t√© d√©tect√©s et document√©s dans la PR" 