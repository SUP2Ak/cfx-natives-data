name: Daily Native Updates

on:
  schedule:
    - cron: '0 0 * * *'  # midnight
  workflow_dispatch:      # manually
    inputs:
      simulate:
        description: 'Simulate changes'
        required: false
        type: boolean
        default: false

jobs:
  update-natives:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          
      - name: Setup initial files
        run: |
          mkdir -p original_assets
          cp assets/* original_assets/
          
      - name: Build and Run
        id: run
        run: |
          if [[ "${{ inputs.simulate }}" == "true" ]]; then
            cargo run --release -- --simulate-change > changes.txt
          else
            cargo run --release > changes.txt
          fi
          echo "CHANGES<<EOF" >> $GITHUB_ENV
          cat changes.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Check for changes
        id: check
        run: |
          diff -r original_assets assets || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Prepare for PR
        if: steps.check.outputs.changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          echo "changes.txt" >> .gitignore
          echo "original_assets/" >> .gitignore
          echo "fetched/" >> .gitignore
          echo "target/" >> .gitignore
          
          git add assets/
          git add .gitignore
          
      - name: Create Pull Request
        if: steps.check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "chore: update natives data"
          title: "${{ inputs.simulate && 'üß™ Test - ' || 'ü§ñ ' }}Daily Natives Update"
          body: |
            ## Detected Changes
            
            ${{ inputs.simulate && '‚ö†Ô∏è This is a simulation of changes ‚ö†Ô∏è\n\n' || '' }}
            ```
            ${{ env.CHANGES }}
            ```
            
            This PR was automatically generated by the daily update workflow.
          branch: update/natives-data
          base: main
          delete-branch: true
          labels: |
            automated pr
            natives update
            ${{ inputs.simulate && 'simulation' || '' }}

      - name: Check PR Status
        if: steps.check.outputs.changes == 'true'
        run: |
          echo "Pull Request created successfully"
          echo "The changes have been detected and documented in the PR" 